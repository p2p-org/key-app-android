version: 2.1

orbs:
  android: circleci/android@2.0

defaults: &defaults
  working_directory: ~/app
  executor:
    name: android/android-machine
    resource-class: xlarge
    tag: 2021.10.1

jobs:
  init:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: "Generate build version"
          command: |
            ./gradlew --no-daemon -g /cache setVersionBuild -Pversion=<< pipeline.id >>
            echo "Set build version to << pipeline.id >>"
  ktlint:
    <<: *defaults
    steps:
      - run:
          name: "Static analysis"
          command: ./gradlew ktlint -PautoCorrect=0
  tests:
    <<: *defaults
    steps:
      - name: "Running unit tests"
      - android/restore-gradle-cache
      - android/restore-build-cache
      - android/run-tests:
          test-command: ./gradlew testDebug
      - run:
          name: "Save test results"
          command: |
            mkdir -p ~/test-results/junit/
            find . -type f -regex ".*/build/test-results/.*xml" -exec cp {} ~/test-results/junit/ \;
          when: always
      - store_test_results:
          path: ~/test-results
      - store_artifacts:
          path: ~/test-results/junit
      - android/save-gradle-cache
      - android/save-build-cache
  publish-feature-build:
    <<: *defaults
    steps:
      - android/restore-gradle-cache
      - android/restore-build-cache
      - run:
          name: "Build and upload artifact to Firebase App Distribution"
          command: ./gradlew --no-daemon -g /cache assembleFeature appDistributionUploadFeature
      - store_artifacts:
          path: app/build/outputs/apk/feature

workflows:
  version: 2

  static-analysis-workflow:
    jobs:
      - init
      - ktlint
          filters:
            branches:
              only:
                - /(^feature\/.+)/
  tests-workflow:
    jobs:
      - tests
  publish-workflow:
    jobs:
      - publish-feature-build
          filters:
            branches:
              only:
                - develop
